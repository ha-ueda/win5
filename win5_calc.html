<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>WIN5 本命あり買い目計算ツール</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: "Segoe UI", sans-serif; margin: 20px; background: #f9fafb; color: #333; }
h1 { font-size: 22px; margin-bottom: 15px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #cce0ff; padding: 4px; text-align: center; font-size: 18px; }
th { background-color: #e0f0ff; font-weight: bold; }
td:first-child { font-weight: bold; }

/* カスタムプルダウン */
.custom-select { position: relative; width: 40px; cursor: pointer; margin: 0 auto; display: inline-block;}
.selected { background-color: white; border: 1px solid #aaa; border-radius: 4px; padding: 4px 2px; text-align: center; }
.options {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid #aaa;
    border-radius: 4px;
    z-index: 102; /* オーバーレイより前面 */
    width: 100%;
}
#overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 101; /* options の下 */
}
.option { padding: 4px 0; text-align: center; }
.option:hover { background-color: #cce0ff; }

/* 結果表示 */
#result { margin-top: 20px; font-weight: bold; font-size: 18px; }
button.calc-btn { padding: 10px 16px; margin-top: 10px; font-size: 16px; background-color: #0078d4; color: white; border: none; border-radius: 6px; cursor: pointer; }
button.calc-btn:hover { background-color: #005fa3; }
#combos { margin-top: 10px; width: 100%; min-height: 150px; padding: 6px; font-family: monospace; font-size: 14px; box-sizing: border-box; white-space: pre-wrap; word-wrap: break-word; resize: none; }

/* クリアボタン */
.clear-btn {
    padding: 4px 6px;
    font-size: 18px;
    background-color: #edebe5;
    color: #444;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    box-sizing: border-box;
}

/* フッターセル折り返し防止 */
tfoot td {
    white-space: nowrap;
    padding: 2px;
}
</style>
</head>
<body>

<h1>WIN5 本命あり買い目計算ツール</h1>

<table id="raceTable">
<thead>
<tr>
<th>馬番</th>
<th>WIN1</th>
<th>WIN2</th>
<th>WIN3</th>
<th>WIN4</th>
<th>WIN5</th>
</tr>
</thead>
<tbody id="raceBody"></tbody>
<tfoot>
<tr>
<td></td>
<td><button class="clear-btn" onclick="clearColumn(1)">クリア</button></td>
<td><button class="clear-btn" onclick="clearColumn(2)">クリア</button></td>
<td><button class="clear-btn" onclick="clearColumn(3)">クリア</button></td>
<td><button class="clear-btn" onclick="clearColumn(4)">クリア</button></td>
<td><button class="clear-btn" onclick="clearColumn(5)">クリア</button></td>
</tr>
</tfoot>
</table>

<div style="margin-top:16px;">
本命が最低
<select id="minFav" style="font-size: 16px;">
<option value="1" selected>1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select> 頭当たらないとハズレ
</div>

<button class="calc-btn" onclick="calc()">計算する</button>
<div id="result"></div>
<textarea id="combos" readonly placeholder="まとめた買い目がここに表示されます"></textarea>

<!-- オーバーレイ -->
<div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:100;"></div>

<script>
const TOTAL_RACES = 5;
const HORSE_MAX = 18;
const MARKS = ["--", "◎", "◯", "▲", "△", "★", "☆", "✓"];

function toCircleNumber(num) {
    const circleNums = ['①','②','③','④','⑤','⑥','⑦','⑧','⑨','⑩','⑪','⑫','⑬','⑭','⑮','⑯','⑰','⑱'];
    return (num>=1&&num<=18)?circleNums[num-1]:String(num);
}

// カスタムプルダウン作成
function createCustomSelect(raceNum, horseNum) {
    const wrapper = document.createElement("div");
    wrapper.className = "custom-select";
    wrapper.dataset.race = raceNum;
    wrapper.dataset.horse = horseNum;

    const selected = document.createElement("div");
    selected.className = "selected";
    selected.textContent = "--";
    selected.style.color = "#333";           
    selected.style.backgroundColor = "#fff"; 

    const options = document.createElement("div");
    options.className = "options";

    MARKS.forEach(mark => {
        const opt = document.createElement("div");
        opt.className = "option";
        opt.textContent = mark;
        opt.addEventListener("click", e => {
            selected.textContent = mark;
            if(mark === "--") {
                selected.style.color = "#333";
                selected.style.backgroundColor = "#fff";
            } else {
                selected.style.color = "#fff";
                selected.style.backgroundColor = "#ef5350";
            }
            options.style.display = "none";
            document.getElementById('overlay').style.display = 'none';
            saveState();
        });
        options.appendChild(opt);
    });

    selected.addEventListener("click", e => {
        e.stopPropagation();
        document.querySelectorAll(".options").forEach(o => o.style.display = "none");
        options.style.display = "block";
        document.getElementById('overlay').style.display = 'block';
    });

    wrapper.appendChild(selected);
    wrapper.appendChild(options);
    return wrapper;
}

// テーブル作成
function createTable() {
    const tbody = document.getElementById('raceBody');
    for (let i=1;i<=HORSE_MAX;i++){
        const tr = document.createElement('tr');
        const tdNum = document.createElement('td');
        tdNum.textContent = toCircleNumber(i);
        tr.appendChild(tdNum);

        for (let r=1;r<=TOTAL_RACES;r++){
            const td = document.createElement('td');
            td.appendChild(createCustomSelect(r,i));
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    }
}

// 状態保存
function saveState(){
    const state={races:{},minFav:document.getElementById('minFav').value};
    for(let r=1;r<=TOTAL_RACES;r++){
        state.races[`r${r}`]={};
        document.querySelectorAll(`.custom-select[data-race="${r}"]`).forEach(sel=>{
            const selectedDiv = sel.querySelector('.selected');
            state.races[`r${r}`][sel.dataset.horse] = {
                mark: selectedDiv.textContent,
                color: selectedDiv.style.color,
                bg: selectedDiv.style.backgroundColor
            };
        });
    }
    localStorage.setItem('win5_state_v4',JSON.stringify(state));
}

// 状態復元
function restoreState(){
    const data=localStorage.getItem('win5_state_v4');
    if(!data) return;
    try{
        const state=JSON.parse(data);
        if(state.minFav) document.getElementById('minFav').value=state.minFav;
        for(let r=1;r<=TOTAL_RACES;r++){
            const race=state.races[`r${r}`];
            if(!race) continue;
            document.querySelectorAll(`.custom-select[data-race="${r}"]`).forEach(sel=>{
                const val=race[sel.dataset.horse];
                if(val){
                    const selectedDiv = sel.querySelector('.selected');
                    selectedDiv.textContent = val.mark;
                    selectedDiv.style.color = val.color;
                    selectedDiv.style.backgroundColor = val.bg;
                }
            });
        }
    }catch(e){console.error(e);}
}

// 列クリア機能
function clearColumn(colNum){
    document.querySelectorAll(`.custom-select[data-race="${colNum}"]`).forEach(sel=>{
        const selectedDiv = sel.querySelector('.selected');
        selectedDiv.textContent = "--";
        selectedDiv.style.color = "#333";
        selectedDiv.style.backgroundColor = "#fff";
    });
    saveState();
}

// 組み合わせ取得
function getRaceData(r){
    const favs=[], himo=[];
    document.querySelectorAll(`.custom-select[data-race="${r}"]`).forEach(sel=>{
        const val=sel.querySelector('.selected').textContent;
        if(val==="◎") favs.push(Number(sel.dataset.horse));
        if(val==="✓") himo.push(Number(sel.dataset.horse));
    });
    const all=[...new Set([...favs,...himo])];
    return {fav:favs, horse:all};
}

function cartesian(arrays){ return arrays.reduce((a,b)=>a.flatMap(d=>b.map(e=>[...d,e])),[[]]); }
function combinations(arr,k){ const res=[]; function helper(s,comb){ if(comb.length===k){ res.push([...comb]); return; } for(let i=s;i<arr.length;i++){ comb.push(arr[i]); helper(i+1,comb); comb.pop(); } } helper(0,[]); return res; }

function calc(){
    const r=[],f=[];
    for(let i=1;i<=TOTAL_RACES;i++){
        const data=getRaceData(i);
        r.push(data.horse);
        f.push(data.fav);
    }
    const minFav=Number(document.getElementById('minFav').value);
    let totalValid=0, comboList=[];
    for(let k=TOTAL_RACES;k>=minFav;k--){
        const masks=combinations([...Array(TOTAL_RACES).keys()],k);
        let validForK=0;
        masks.forEach(mask=>{
            const candidates=[];
            for(let i=0;i<TOTAL_RACES;i++){
                if(mask.includes(i)) candidates.push(f[i]);
                else candidates.push(r[i].filter(x=>!f[i].includes(x)));
            }
            if(candidates.every(a=>a.length>0)) validForK+=cartesian(candidates).length;
        });
        comboList.push(`--- 本命が${k}頭当たる組み合わせ ${validForK}通り ---`);
        masks.forEach(mask=>{
            const candidates=[];
            for(let i=0;i<TOTAL_RACES;i++){
                if(mask.includes(i)) candidates.push(f[i]);
                else candidates.push(r[i].filter(x=>!f[i].includes(x)));
            }
            if(candidates.every(a=>a.length>0)){
                const line=candidates.map(a=>a.map(n=>toCircleNumber(n)).join('')).join('-');
                comboList.push(line);
            }
        });
        totalValid+=validForK;
    }
    document.getElementById('result').innerHTML=`総買い目：<span style="color:#0078d4;">${totalValid.toLocaleString()}</span> 通り`;
    const combosArea=document.getElementById('combos');
    combosArea.value=comboList.join('\n');
    combosArea.style.height='auto';
    combosArea.style.height=combosArea.scrollHeight+'px';
    saveState();
}

// 初期化
createTable();
restoreState();

// 初期値未設定の selected に "--" をセット
document.querySelectorAll('.custom-select .selected').forEach(sel=>{
    if(!sel.textContent) {
        sel.textContent = "--";
        sel.style.color = "#333";
        sel.style.backgroundColor = "#fff";
    }
});

// オーバーレイクリックで全てのオプションを閉じる
document.getElementById('overlay').addEventListener("click",()=>{
    document.querySelectorAll(".options").forEach(o => o.style.display="none");
    document.getElementById('overlay').style.display='none';
});

// 画面クリックで全てのオプションを閉じる
document.addEventListener("click",()=>document.querySelectorAll(".options").forEach(o=>o.style.display="none"));

</script>
</body>
</html>
