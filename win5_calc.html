<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>WIN5 本命あり買い目計算ツール</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: "Segoe UI", sans-serif; margin: 20px; background: #f9fafb; color: #333; }
h1 { font-size: 22px; margin-bottom: 15px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #d9d8ce; padding: 4px; text-align: center; font-size: 18px; }
th { background-color: #e0f0ff; font-weight: bold; }
button.calc-btn { padding: 10px 16px; margin-top: 10px; font-size: 16px; background-color: #0078d4; color: white; border: none; border-radius: 6px; cursor: pointer; }
button.calc-btn:hover { background-color: #005fa3; }
#result { margin-top: 20px; font-weight: bold; font-size: 18px; }
#combos {
	margin-top: 10px;
	font-family: monospace;
	font-size: 18px;
	white-space: pre-wrap;
	word-break: keep-all;
	overflow-x: auto;
	display: block;
}
.clear-btn {
	padding: 4px 6px;
	font-size: 18px;
	background-color: #edebe5;
	color: #444;
	border: none;
	border-radius: 4px;
	cursor: pointer;
	width: 100%;
	box-sizing: border-box;
}
.custom-select {
	touch-action: manipulation;
	display: flex;
	align-items: center;
	gap: 4px;
	cursor: pointer;
	width: fit-content;
	margin: 0 auto;
}
.selected {
	touch-action: manipulation;
	background-color: white;
	border: 1px solid #aaa;
	border-radius: 4px;
	padding: 4px 2px;
	text-align: center;
	user-select: none;
	width: 32px;
	height: 32px;
	line-height: 32px;
	font-size: 18px;
	font-weight: bold;
}
.custom-select .horse-label {
	display: flex;
	width: 32px;
	height: 32px;
	align-items: center;
	justify-content: center;
	font-size: 18px !important;
	font-weight: bold;
	color: #555;
	user-select: none;
}
.toggle-container {
	display: flex;
	align-items: center;
	gap: 8px;
	margin-bottom: 10px;
	font-size: 16px;
}
.switch {
	position: relative;
	width: 46px;
	height: 24px;
	background: #ccc;
	border-radius: 24px;
	cursor: pointer;
	transition: background 0.2s;
}
.switch::after {
	content: "";
	position: absolute;
	top: 2px;
	left: 2px;
	width: 20px;
	height: 20px;
	background: #fff;
	border-radius: 50%;
	transition: left 0.2s;
}
.switch.on {
	background: #2196F3;
}
.switch.on::after {
	left: 24px;
}
table thead th { background: #f4f2ec !important; }
#raceBody tr:nth-child(even) td { background: #fbfbfb !important; }
* { -webkit-tap-highlight-color: rgba(0,0,0,0); }
.custom-select, .custom-select * { -webkit-user-select: none; user-select: none; }
.selected:focus { outline: none; }
</style>
</head>
<body>

<h1>WIN5 本命あり買い目計算ツール</h1>

<div class="toggle-container">
  背景選択
  <div id="modeToggle" class="switch"></div>
</div>

<table id="raceTable">
<thead>
<tr>
<th>WIN1</th><th>WIN2</th><th>WIN3</th><th>WIN4</th><th>WIN5</th>
</tr>
</thead>
<tbody id="raceBody"></tbody>
<tfoot>
<tr>
<td><button class="clear-btn" onclick="clearColumn(1)">クリア</button></td>
<td><button class="clear-btn" onclick="clearColumn(2)">クリア</button></td>
<td><button class="clear-btn" onclick="clearColumn(3)">クリア</button></td>
<td><button class="clear-btn" onclick="clearColumn(4)">クリア</button></td>
<td><button class="clear-btn" onclick="clearColumn(5)">クリア</button></td>
</tr>
</tfoot>
</table>

<div style="margin-top:18px;">
	本命
	<select id="minFav" style="font-size: 18px;">
		<option value="1" selected>1</option>
		<option value="2">2</option>
		<option value="3">3</option>
		<option value="4">4</option>
		<option value="5">5</option>
	</select> 勝以上
</div>

<div style="display: flex; justify-content: flex-end; margin-top: 6px;">
	<button class="calc-btn" onclick="calc()">計算する</button>
</div>

<div id="result"></div>
<div id="loading" style="display:none; margin-top:10px; font-size:18px;">計算中...</div>
<div id="combos"></div>

<script>
const TOTAL_RACES = 5;
const HORSE_MAX = 18;
const MARKS = ["", "✔", "◎"];
const COLORS = ["none", "red", "blue", "yellow"];
const COLOR_MAP = { none: "", red: "#ffb3b3", blue: "#b3d1ff", yellow: "#fff3b3" };
const CIRCLES = ['①','②','③','④','⑤','⑥','⑦','⑧','⑨','⑩','⑪','⑫','⑬','⑭','⑮','⑯','⑰','⑱'];

let backgroundMode = false;
const modeBtn = document.getElementById("modeToggle");

function updateSwitch(){ backgroundMode ? modeBtn.classList.add("on") : modeBtn.classList.remove("on"); }

modeBtn.addEventListener("click", () => {
	backgroundMode = !backgroundMode;
	updateSwitch();
	if (backgroundMode) {
		document.querySelectorAll(".selected").forEach(d => {
			if (!d.dataset.bg) d.dataset.bg = "none";
			d.style.backgroundColor = COLOR_MAP[d.dataset.bg];
		});
	}
});
updateSwitch();

function toCircleNumber(num){ return CIRCLES[num-1] || String(num); }

function createCustomSelect(raceNum, horseNum){
	const wrapper=document.createElement("div");
	wrapper.className="custom-select";
	wrapper.dataset.race=raceNum;
	wrapper.dataset.horse=horseNum;

	const selected=document.createElement("div");
	selected.className="selected";
	selected.textContent="";
	selected.dataset.bg="none";
	selected.addEventListener("click",()=>{
		if(backgroundMode){
			const next=(COLORS.indexOf(selected.dataset.bg)+1)%COLORS.length;
			selected.dataset.bg=COLORS[next];
			selected.style.backgroundColor=COLOR_MAP[selected.dataset.bg];
		}else{
			const cur=MARKS.indexOf(selected.textContent);
			selected.textContent=MARKS[(cur+1)%MARKS.length];
		}
		saveState();
	});
	const label=document.createElement("span");
	label.className="horse-label";
	label.textContent=toCircleNumber(horseNum);
	wrapper.appendChild(label);
	wrapper.appendChild(selected);
	return wrapper;
}

function createTable(){
	const tbody=document.getElementById('raceBody');
	for(let i=1;i<=HORSE_MAX;i++){
		const tr=document.createElement('tr');
		for(let r=1;r<=TOTAL_RACES;r++){
			const td=document.createElement('td');
			td.appendChild(createCustomSelect(r,i));
			tr.appendChild(td);
		}
		tbody.appendChild(tr);
	}
}

function saveState(){
	const state={races:{},minFav:document.getElementById('minFav').value};
	for(let r=1;r<=TOTAL_RACES;r++){
		state.races[`r${r}`]={};
		document.querySelectorAll(`.custom-select[data-race="${r}"]`).forEach(sel=>{
			const d=sel.querySelector('.selected');
			state.races[`r${r}`][sel.dataset.horse]={mark:d.textContent,bg:d.dataset.bg};
		});
	}
	localStorage.setItem('win5_state_v5',JSON.stringify(state));
}

function restoreState(){
	const data=localStorage.getItem('win5_state_v5');
	if(!data) return;
	try{
		const state=JSON.parse(data);
		document.getElementById('minFav').value=state.minFav;
		for(let r=1;r<=TOTAL_RACES;r++){
			const race=state.races[`r${r}`];
			if(!race) continue;
			document.querySelectorAll(`.custom-select[data-race="${r}"]`).forEach(sel=>{
				const val=race[sel.dataset.horse];
				if(val){
					const d=sel.querySelector('.selected');
					d.textContent=val.mark;
					d.dataset.bg=val.bg;
					d.style.backgroundColor=COLOR_MAP[val.bg];
				}
			});
		}
	}catch(e){}
}

function clearColumn(colNum){
	document.querySelectorAll(`.custom-select[data-race="${colNum}"]`).forEach(sel=>{
		const d=sel.querySelector(".selected");
		d.textContent="";
		d.dataset.bg="none";
		d.style.backgroundColor="";
	});
	saveState();
}

function getRaceData(r){
	const favs=[],himo=[],colorMap={};
	document.querySelectorAll(`.custom-select[data-race="${r}"]`).forEach(sel=>{
		const v=sel.querySelector('.selected').textContent;
		const bg=sel.querySelector('.selected').dataset.bg;
		const num=Number(sel.dataset.horse);
		colorMap[num]=bg;
		if(v==="◎") favs.push(num);
		if(v==="✔") himo.push(num);
	});
	const all=[...new Set([...favs,...himo])];
	return {fav:favs,horse:all,colorMap};
}

function combinations(arr,k){ const res=[]; (function h(s,c){ if(c.length===k){res.push([...c]);return;} for(let i=s;i<arr.length;i++){ c.push(arr[i]); h(i+1,c); c.pop(); } })(0,[]); return res; }

function setEq(a,b){ if(a.size!==b.size) return false; for(const x of a) if(!b.has(x)) return false; return true; }
function setUnion(a,b){ const s=new Set(a); for(const x of b) s.add(x); return s; }
function setInterEmpty(a,b){ for(const x of a) if(b.has(x)) return false; return true; }

function fullyMergeBlocksStable(blocks){
	let merged=true;
	while(merged){
		merged=false;
		const newBlocks=[];
		const used=new Set();
		for(let i=0;i<blocks.length;i++){
			if(used.has(i)) continue;
			let base=blocks[i];
			for(let j=i+1;j<blocks.length;j++){
				if(used.has(j)) continue;
				const A=base,B=blocks[j];
				let diff=-1,diffCount=0,ok=true;
				for(let r=0;r<TOTAL_RACES;r++){
					if(setEq(A[r],B[r])) continue;
					diffCount++;
					if(diffCount>1){ ok=false; break; }
					diff=r;
				}
				if(ok&&diffCount===1&&setInterEmpty(A[diff],B[diff])){
					base=A.map((s,idx)=>idx===diff?setUnion(A[idx],B[idx]):s);
					used.add(j);
					merged=true;
				}
			}
			newBlocks.push(base);
		}
		blocks=newBlocks;
	}
	return blocks;
}

function blockToLine(block,colorMaps){
	return block.map((set,raceIdx)=>{
		const arr=[...set].sort((a,b)=>a-b).map(n=>{
			const bg=colorMaps[raceIdx][n];
			const color=(bg&&bg!=="none")?COLOR_MAP[bg]:"";
			const num=toCircleNumber(n);
			return color?`<span style="background-color:${color}; padding:1px 3px; border-radius:4px;">${num}</span>`:num;
		}).join('');
		return arr;
	}).join('&#8209;');
}

async function calc(){
	const loading=document.getElementById('loading');
	loading.style.display='block';
	await new Promise(r=>setTimeout(r,50));

	const races=[],favs=[],colorMaps=[];
	for(let i=1;i<=TOTAL_RACES;i++){
		const d=getRaceData(i);
		races.push(d.horse);
		favs.push(d.fav);
		colorMaps.push(d.colorMap);
	}

	const colorBits=colorMaps.map(m=>{
		const c={};
		for(const k in m)
			c[k]=m[k]==="red"?1:m[k]==="blue"?2:m[k]==="yellow"?4:0;
		return c;
	});

	function isColorDuplicateBits(combo){
		let used=0;
		for(let i=0;i<combo.length;i++){
			const bit=colorBits[i][combo[i]];
			if(bit&&(used&bit)) return true;
			used|=bit;
		}
		return false;
	}

	function* cartesianGen(arrays,isValid){
		const n=arrays.length;
		const indices=Array(n).fill(0);
		while(true){
			const combo=arrays.map((a,i)=>a[indices[i]]);
			if(!isValid||isValid(combo)) yield combo;
			let i=n-1;
			while(i>=0&&++indices[i]===arrays[i].length) indices[i--]=0;
			if(i<0) break;
		}
	}

	const minFav=Number(document.getElementById('minFav').value);
	let total=0;
	const comboList=[];

	for(let k=TOTAL_RACES;k>=minFav;k--){
		await new Promise(r=>setTimeout(r,0));
		const masks=combinations([...Array(TOTAL_RACES).keys()],k);
		let count=0;
		let blocks=[];

		for(const mask of masks){
			const candidates=[];
			for(let i=0;i<TOTAL_RACES;i++){
				candidates.push(mask.includes(i)
					? favs[i]
					: races[i].filter(x=>!favs[i].includes(x)));
			}
			if(!candidates.every(a=>a.length>0)) continue;

			for(const combo of cartesianGen(candidates,c=>!isColorDuplicateBits(c))){
				count++;
				blocks.push(combo.map(v=>new Set([v])));
			}
		}

		blocks=fullyMergeBlocksStable(blocks);
		comboList.push(`─── 本命${k}勝：${count}通り ───`);
		blocks.forEach(b=>comboList.push(blockToLine(b,colorMaps)));
		total+=count;
	}

	document.getElementById('result').innerHTML=`総買い目：<span style="color:#0078d4;">${total.toLocaleString()}</span> 通り`;
	document.getElementById('combos').innerHTML=comboList.join('\n');
	saveState();
	loading.style.display='none';
}

createTable();
restoreState();
</script>

</body>
</html>