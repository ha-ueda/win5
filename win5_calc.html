<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>WIN5 本命あり買い目計算ツール</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: "Segoe UI", sans-serif; margin: 20px; background: #f9fafb; color: #333; }
h1 { font-size: 22px; margin-bottom: 15px; }

.race-row {
    margin-bottom: 15px;
    padding: 10px;
    border: 2px solid #cce0ff;
    border-radius: 8px;
    background-color: #f0f8ff;
}

.race-label { font-weight: bold; margin-bottom: 8px; font-size: 18px; }

.checks-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.checks {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.checks label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 55px;
    height: 70px;
    font-size: 20px;
}

.checks input {
    transform: scale(2.2);
    margin-bottom: 6px;
}

.check-buttons {
    margin-top: 6px;
}

.check-buttons button {
    margin-right: 6px;
    padding: 4px 8px;
    font-size: 14px;
}

select {
    font-size: 18px;
    padding: 8px 12px;
}

#result { 
    margin-top: 20px; 
    font-weight: bold; 
    font-size: 18px; 
}

#result-container {
    margin-top: 15px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.copy-btn {
    padding: 8px 14px;
    font-size: 14px;
    background-color: #0078d4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
}
.copy-btn:hover { background-color: #005fa3; }

#combos {
    margin-top: 10px;
    width: 100%;
    min-height: 150px;
    padding: 10px;
    font-family: monospace;
    font-size: 16px;
    box-sizing: border-box;
    white-space: pre-wrap;
    word-wrap: break-word;
    resize: none;
}

.toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 1000;
}
.toast.show { opacity: 1; }

button.calc-btn {
    width: 100%;
    max-width: 300px;
    padding: 14px;
    background-color: #0078d4;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    margin-top: 10px;
}
button.calc-btn:hover { background-color: #005fa3; }
</style>
</head>
<body>

<h1>WIN5 本命あり買い目計算ツール</h1>

<div id="races"></div>

<div style="margin-top:15px;">
本命が最低
<select id="minFav">
<option value="1" selected>1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select> 頭当たらないとハズレ
</div>

<button class="calc-btn" onclick="calc()">計算する</button>

<div id="result-container">
  <div id="result"></div>
  <button class="copy-btn" onclick="copyCombos()">コピー</button>
</div>

<textarea id="combos" readonly placeholder="まとめた買い目がここに表示されます"></textarea>

<div id="toast" class="toast">コピーしました！</div>

<script>
// 数字 → 丸数字 (1〜18)
function toCircleNumber(num) {
    const circleNums = ['①','②','③','④','⑤','⑥','⑦','⑧','⑨','⑩','⑪','⑫','⑬','⑭','⑮','⑯','⑰','⑱'];
    return (num >= 1 && num <= 18) ? circleNums[num - 1] : String(num);
}

const TOTAL_RACES = 5;
const HORSE_MAX = 18;

// チェックボックス生成
function createRaceCheckboxes(raceNum) {
    const container = document.createElement('div');
    container.className = 'race-row';

    const label = document.createElement('div');
    label.className = 'race-label';
    label.textContent = `WIN${raceNum}`;
    container.appendChild(label);

    const checksContainer = document.createElement('div');
    checksContainer.className = 'checks-container';

    for (const type of ['fav', 'horse']) {
        const div = document.createElement('div');
        div.textContent = type === 'fav' ? '本命' : '紐';
        const checks = document.createElement('div');
        checks.className = `checks r${raceNum}-${type}`;

        for (let i = 1; i <= HORSE_MAX; i++) {
            const l = document.createElement('label');
            l.innerHTML = `<input type="checkbox" value="${i}">${toCircleNumber(i)}`;
            checks.appendChild(l);
        }

        const btns = document.createElement('div');
        btns.className = 'check-buttons';
        btns.innerHTML = `
          <button type="button" onclick="checkAll('r${raceNum}-${type}')">全てチェック</button>
          <button type="button" onclick="uncheckAll('r${raceNum}-${type}')">全て解除</button>`;
        div.appendChild(checks);
        div.appendChild(btns);
        checksContainer.appendChild(div);
    }

    container.appendChild(checksContainer);
    document.getElementById('races').appendChild(container);
}

// 全レース生成
for (let i = 1; i <= TOTAL_RACES; i++) createRaceCheckboxes(i);

// チェック操作
function checkAll(className) {
    document.querySelectorAll(`.${className} input`).forEach(i => i.checked = true);
    saveState();
}
function uncheckAll(className) {
    document.querySelectorAll(`.${className} input`).forEach(i => i.checked = false);
    saveState();
}

// チェックボックス値取得
function getCheckedValues(className) {
    return Array.from(document.querySelectorAll(`.${className} input:checked`)).map(i => Number(i.value));
}

// デカルト積
function cartesian(arrays) {
    return arrays.reduce((a, b) => a.flatMap(d => b.map(e => [...d, e])), [[]]);
}

// n個からk個選ぶ
function combinations(arr, k) {
    const res = [];
    function helper(start, comb) {
        if (comb.length === k) { res.push([...comb]); return; }
        for (let i = start; i < arr.length; i++) {
            comb.push(arr[i]);
            helper(i + 1, comb);
            comb.pop();
        }
    }
    helper(0, []);
    return res;
}

// 状態保存
function saveState() {
    const state = { races: {}, minFav: document.getElementById('minFav').value };
    for (let i = 1; i <= TOTAL_RACES; i++) {
        state.races[`r${i}`] = {
            fav: getCheckedValues(`r${i}-fav`),
            horse: getCheckedValues(`r${i}-horse`)
        };
    }
    localStorage.setItem('win5_state', JSON.stringify(state));
}

// 状態復元
function restoreState() {
    const data = localStorage.getItem('win5_state');
    if (!data) return;
    try {
        const state = JSON.parse(data);
        if (state.minFav) document.getElementById('minFav').value = state.minFav;
        for (let i = 1; i <= TOTAL_RACES; i++) {
            const race = state.races[`r${i}`];
            if (!race) continue;
            for (const type of ['fav', 'horse']) {
                const values = race[type] || [];
                document.querySelectorAll(`.r${i}-${type} input`).forEach(i => {
                    i.checked = values.includes(Number(i.value));
                });
            }
        }
    } catch(e) { console.error('restore error', e); }
}

// 入力変化で保存
document.addEventListener('change', e => {
    if (e.target.matches('input[type="checkbox"], #minFav')) saveState();
});

// 計算
function calc() {
    const r = [], f = [];
    for (let i = 1; i <= TOTAL_RACES; i++) {
        let horses = getCheckedValues(`r${i}-horse`);
        let favs = getCheckedValues(`r${i}-fav`);
        if (horses.length === 0 && favs.length > 0) horses = [...favs];
        r.push(horses);
        f.push(favs);
    }

    const minFav = Number(document.getElementById('minFav').value);
    let totalValid = 0, comboList = [];

    for (let k = TOTAL_RACES; k >= minFav; k--) {
        const masks = combinations([...Array(TOTAL_RACES).keys()], k);
        let validForK = 0;

        masks.forEach(mask => {
            const candidates = [];
            for (let i = 0; i < TOTAL_RACES; i++) {
                if (mask.includes(i)) candidates.push(f[i]);
                else candidates.push(r[i].filter(x => !f[i].includes(x)));
            }
            if (candidates.every(arr => arr.length > 0)) validForK += cartesian(candidates).length;
        });

        comboList.push(`--- 本命が${k}頭当たる組み合わせ ${validForK}通り ---`);

        masks.forEach(mask => {
            const candidates = [];
            for (let i = 0; i < TOTAL_RACES; i++) {
                if (mask.includes(i)) candidates.push(f[i]);
                else candidates.push(r[i].filter(x => !f[i].includes(x)));
            }
            if (candidates.every(arr => arr.length > 0)) {
                const line = candidates.map(arr => arr.map(toCircleNumber).join('')).join('-');
                comboList.push(line);
            }
        });

        totalValid += validForK;
    }

    document.getElementById('result').innerHTML =
        `総買い目：<span style="color:#0078d4;">${totalValid.toLocaleString()}</span> 通り`;

    const combosArea = document.getElementById('combos');
    combosArea.value = comboList.join('\n');
    combosArea.style.height = 'auto';
    combosArea.style.height = combosArea.scrollHeight + 'px';

    saveState(); // 計算後も保存
}

// コピー機能（トースト表示）
function copyCombos() {
    const textarea = document.getElementById('combos');
    const text = textarea.value;
    navigator.clipboard.writeText(text).then(() => {
        const toast = document.getElementById('toast');
        toast.textContent = 'コピーしました';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    });
}

// ページ読み込み時に復元
restoreState();
</script>

</body>
</html>