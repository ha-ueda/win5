<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>WIN5 本命あり買い目計算ツール</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: "Segoe UI", sans-serif; margin: 20px; background: #f9fafb; color: #333; }
h1 { font-size: 22px; margin-bottom: 15px; }
.race-row { margin-bottom: 15px; padding: 10px; border: 2px solid #cce0ff; border-radius: 8px; background-color: #f0f8ff; }
.race-label { font-weight: bold; margin-bottom: 8px; font-size: 18px; }
.checks-container { display: flex; flex-direction: column; gap: 8px; }
.checks { display: flex; flex-wrap: wrap; gap: 6px; }
.checks label { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 55px; height: 70px; font-size: 20px; transition: background 0.2s; }
.checks input { transform: scale(2.2); margin-bottom: 6px; }
.check-buttons { margin-top: 6px; }
.check-buttons button { margin-right: 6px; padding: 4px 8px; font-size: 14px; }
select { font-size: 18px; padding: 8px 12px; }
#result { margin-top: 20px; font-weight: bold; font-size: 18px; }
#result-container { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }
.copy-btn { padding: 8px 14px; font-size: 14px; background-color: #0078d4; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
.copy-btn:hover { background-color: #005fa3; }
#combos { margin-top: 10px; width: 100%; min-height: 150px; padding: 10px; font-family: monospace; font-size: 16px; box-sizing: border-box; white-space: pre-wrap; resize: none; }
.toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 6px; font-size: 16px; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
.toast.show { opacity: 1; }
button.calc-btn { width: 100%; max-width: 300px; padding: 14px; background-color: #0078d4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; margin-top: 10px; }
button.calc-btn:hover { background-color: #005fa3; }
</style>
</head>
<body>

<h1>WIN5 本命あり買い目計算ツール</h1>
<div id="races"></div>

<div style="margin-top:15px;">
本命が最低
<select id="minFav">
<option value="1" selected>1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select> 頭当たらないとハズレ
</div>

<button class="calc-btn" onclick="calc()">計算する</button>

<div id="result-container">
  <div id="result"></div>
  <button class="copy-btn" onclick="copyCombos()">コピー</button>
</div>

<textarea id="combos" readonly placeholder="まとめた買い目がここに表示されます"></textarea>
<div id="toast" class="toast">コピーしました！</div>

<script>
function toCircleNumber(num) {
    const n=['①','②','③','④','⑤','⑥','⑦','⑧','⑨','⑩','⑪','⑫','⑬','⑭','⑮','⑯','⑰','⑱'];
    return n[num-1]||num.toString();
}
function createRaceCheckboxes(raceNum){
    const c=document.createElement('div'); c.className='race-row';
    const l=document.createElement('div'); l.className='race-label'; l.textContent=`WIN${raceNum}`; c.appendChild(l);
    const cc=document.createElement('div'); cc.className='checks-container';
    const favDiv=document.createElement('div'); favDiv.textContent='本命';
    const favChecks=document.createElement('div'); favChecks.className=`checks r${raceNum}-fav`;
    for(let i=1;i<=18;i++){const lab=document.createElement('label'); lab.innerHTML=`<input type="checkbox" value="${i}">${toCircleNumber(i)}`; favChecks.appendChild(lab);}
    const favBtns=document.createElement('div'); favBtns.className='check-buttons';
    favBtns.innerHTML=`<button type="button" onclick="checkAll('r${raceNum}-fav')">全てチェック</button><button type="button" onclick="uncheckAll('r${raceNum}-fav')">全て解除</button>`;
    favDiv.append(favChecks,favBtns);
    const horseDiv=document.createElement('div'); horseDiv.textContent='紐';
    const horseChecks=document.createElement('div'); horseChecks.className=`checks r${raceNum}-horse`;
    for(let i=1;i<=18;i++){const lab=document.createElement('label'); lab.innerHTML=`<input type="checkbox" value="${i}">${toCircleNumber(i)}`; horseChecks.appendChild(lab);}
    const horseBtns=document.createElement('div'); horseBtns.className='check-buttons';
    horseBtns.innerHTML=`<button type="button" onclick="checkAll('r${raceNum}-horse')">全てチェック</button><button type="button" onclick="uncheckAll('r${raceNum}-horse')">全て解除</button>`;
    horseDiv.append(horseChecks,horseBtns);
    cc.append(favDiv,horseDiv); c.appendChild(cc); document.getElementById('races').appendChild(c);
}
for(let i=1;i<=5;i++)createRaceCheckboxes(i);

function checkAll(cls){document.querySelectorAll(`.${cls} input`).forEach(i=>i.checked=true);saveStateDebounced();}
function uncheckAll(cls){document.querySelectorAll(`.${cls} input`).forEach(i=>i.checked=false);saveStateDebounced();}
function getCheckedValues(cls){return Array.from(document.querySelectorAll(`.${cls} input:checked`)).map(i=>Number(i.value));}
function combinations(arr,k){let res=[];function h(s,c){if(c.length===k){res.push([...c]);return;}for(let i=s;i<arr.length;i++){c.push(arr[i]);h(i+1,c);c.pop();}}h(0,[]);return res;}

// === 色を正規化して取得するヘルパー ===
function getLabelColorNormalized(label){
    if(!label) return '';
    const c = window.getComputedStyle(label).backgroundColor || '';
    // 'rgba(0, 0, 0, 0)' や 'transparent' を空扱いにする
    if(!c || c === 'transparent' || c === 'rgba(0, 0, 0, 0)') return '';
    return c; // 例: "rgb(255, 182, 182)"
}

// === 色重複フィルタ（組合せの通り数を返す） ===
function filterByColor(candidates, colors){
    let count = 0;
    function dfs(depth, usedColors){
        if(depth === candidates.length){ count++; return; }
        for(const h of candidates[depth]){
            const color = colors[depth][h] || ''; // h は馬番（数値）
            if(color && usedColors.has(color)) continue; // 同色が既に使われているならスキップ
            const nextSet = color ? new Set(usedColors).add(color) : new Set(usedColors);
            // new Set(...).add() returns the set itself, so we clone properly:
            const cloned = new Set(usedColors);
            if(color) cloned.add(color);
            dfs(depth + 1, cloned);
        }
    }
    dfs(0, new Set());
    return count;
}

function calc(){
    const r = [], f = [], colors = [];

    // 各レースのデータ・色を収集
    for(let i=1;i<=5;i++){
        let horses = getCheckedValues(`r${i}-horse`);
        let favs = getCheckedValues(`r${i}-fav`);
        if(horses.length===0 && favs.length>0) horses = [...favs];
        r.push(horses);
        f.push(favs);

        const raceColors = {};
        const favLabels = Array.from(document.querySelectorAll(`.r${i}-fav label`));
        const horseLabels = Array.from(document.querySelectorAll(`.r${i}-horse label`));
        for(let num=1; num<=18; num++){
            const favLabel = favLabels[num-1];
            const horseLabel = horseLabels[num-1];
            const favColor = getLabelColorNormalized(favLabel);
            const horseColor = getLabelColorNormalized(horseLabel);
            raceColors[num] = favColor || horseColor || '';
        }
        colors.push(raceColors);
    }

    const minFav = Number(document.getElementById('minFav').value);
    const raceIdxs = [0,1,2,3,4];
    let totalValid = 0;
    const comboList = [];

    // デカルト積（色重複を除外）
    function dfsGenerate(candidates, colors){
        const result = [];
        const n = candidates.length;

        function dfs(depth, usedColors, path){
            if(depth === n){
                result.push([...path]);
                return;
            }
            const list = candidates[depth];
            if(!Array.isArray(list)) return;
            for(const h of list){
                const color = colors[depth][h] || '';
                if(color && usedColors.has(color)) continue; // 同色除外
                const next = new Set(usedColors);
                if(color) next.add(color);
                path.push(h);
                dfs(depth+1, next, path);
                path.pop();
            }
        }
        dfs(0, new Set(), []);
        return result;
    }

    // メイン計算
    for(let k=5;k>=minFav;k--){
        const masks = combinations(raceIdxs, k);
        let validForK = 0;
        const compactPatterns = new Set();

        for(const mask of masks){
            const candidates = [];
            for(let i=0;i<5;i++){
                const pool = mask.includes(i)
                    ? f[i]
                    : r[i].filter(x => !f[i].includes(x));
                if(pool.length === 0){
                    candidates.length = 0;
                    break;
                }
                candidates.push(pool);
            }
            if(candidates.length < 5) continue;

            const validCombos = dfsGenerate(candidates, colors);
            if(validCombos.length === 0) continue;
            validForK += validCombos.length;

            // 有効な組合せに基づいて、各レースの候補馬番を集約
            const raceSets = Array.from({length:5},()=>new Set());
            validCombos.forEach(cmb=>{
                cmb.forEach((num,idx)=>raceSets[idx].add(num));
            });

            const line = raceSets
                .map(set => Array.from(set).sort((a,b)=>a-b).map(toCircleNumber).join(''))
                .join('-');
            compactPatterns.add(line);
        }

        comboList.push(`--- 本命が${k}頭当たる組み合わせ ${validForK.toLocaleString()}通り ---`);
        if(compactPatterns.size>0) comboList.push(...compactPatterns);
        totalValid += validForK;
    }

    document.getElementById('result').innerHTML =
        `総買い目：<span style="color:#0078d4;">${totalValid.toLocaleString()}</span> 通り`;

    const combosArea = document.getElementById('combos');
    combosArea.value = comboList.join('\n');
    combosArea.style.height = 'auto';
    combosArea.style.height = combosArea.scrollHeight + 'px';
}

// 背景色正規化
function getLabelColorNormalized(label){
    if(!label) return '';
    const color = (label.style.background || '').trim().toLowerCase();
    if(!color || color === 'white' || color === '#ffffff') return '';
    return color;
}

// === コピー ===
function copyCombos(){navigator.clipboard.writeText(document.getElementById('combos').value).then(()=>showToast());}
function showToast(){const t=document.getElementById('toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}

// === 状態保存 ===
function saveState(){
    const s={races:[]};
    for(let i=1;i<=5;i++){
        const race={fav:[],horse:[]};
        document.querySelectorAll(`.r${i}-fav label`).forEach(l=>{
            const input=l.querySelector('input');
            race.fav.push({checked:input.checked,color:l.style.background||''});
        });
        document.querySelectorAll(`.r${i}-horse label`).forEach(l=>{
            const input=l.querySelector('input');
            race.horse.push({checked:input.checked,color:l.style.background||''});
        });
        s.races.push(race);
    }
    s.minFav=document.getElementById('minFav').value;
    localStorage.setItem('win5state',JSON.stringify(s));
}
function loadState(){
    const d=localStorage.getItem('win5state');if(!d)return;
    const s=JSON.parse(d);
    if(s.races){for(let i=1;i<=5;i++){const race=s.races[i-1];if(!race)continue;
        document.querySelectorAll(`.r${i}-fav label`).forEach((l,idx)=>{const input=l.querySelector('input');if(race.fav[idx]){input.checked=!!race.fav[idx].checked;l.style.background=race.fav[idx].color||'';}});
        document.querySelectorAll(`.r${i}-horse label`).forEach((l,idx)=>{const input=l.querySelector('input');if(race.horse[idx]){input.checked=!!race.horse[idx].checked;l.style.background=race.horse[idx].color||'';}});
    }}
    if(s.minFav)document.getElementById('minFav').value=s.minFav;
}
let saveTimer;function saveStateDebounced(){clearTimeout(saveTimer);saveTimer=setTimeout(saveState,300);}
window.addEventListener('DOMContentLoaded',()=>{
    loadState();
    document.querySelectorAll('input[type="checkbox"]').forEach(chk=>chk.addEventListener('change',saveStateDebounced));
    document.getElementById('minFav').addEventListener('input',saveStateDebounced);
});

// === カラーパレット ===
function showColorPalette(target){
    closeColorPalette();
    const p=document.createElement('div');
    p.id='color-palette';
    Object.assign(p.style,{position:'absolute',display:'grid',gridTemplateColumns:'repeat(5,28px)',gap:'4px',padding:'6px',background:'#fff',border:'1px solid #ccc',borderRadius:'8px',boxShadow:'0 2px 6px rgba(0,0,0,0.2)',zIndex:'9999'});
    const colors=['#ffffff','#ffb6b6','#a8d8ff','#a8e6a8','#fff2a8'];
    colors.forEach(c=>{
        const s=document.createElement('div');
        Object.assign(s.style,{width:'28px',height:'28px',background:c,border:'1px solid #888',cursor:'pointer'});
        s.onclick=e=>{
            e.stopPropagation();
            target.style.background=(c==='#ffffff')?'':c;
            closeColorPalette();saveStateDebounced();
        };
        p.appendChild(s);
    });
    const r=target.getBoundingClientRect();
    p.style.left=`${r.left+window.scrollX}px`;
    p.style.top=`${r.bottom+window.scrollY+5}px`;
    document.body.appendChild(p);
    const close=e=>{if(!p.contains(e.target))closeColorPalette();};
    setTimeout(()=>{document.addEventListener('mousedown',close,{once:true});document.addEventListener('touchstart',close,{once:true});},0);
}
function closeColorPalette(){const o=document.getElementById('color-palette');if(o)o.remove();}
document.addEventListener('contextmenu',e=>{const l=e.target.closest('label');if(l){e.preventDefault();showColorPalette(l);}});
let touchTimer;
document.addEventListener('touchstart',e=>{const l=e.target.closest('label');if(!l)return;touchTimer=setTimeout(()=>showColorPalette(l),600);});
document.addEventListener('touchend',()=>clearTimeout(touchTimer));
document.addEventListener('touchmove',()=>clearTimeout(touchTimer));
</script>
</body>
</html>
